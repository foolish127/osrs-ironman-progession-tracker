<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoolinSlays - Progress Editor</title>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-gold: #d4a84b;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-purple: #a371f7;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg-dark); color: var(--text-primary); min-height: 100vh; padding: 2rem; }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: var(--accent-gold); margin-bottom: 0.5rem; }
        .subtitle { color: var(--text-secondary); margin-bottom: 2rem; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .tab { padding: 0.75rem 1.5rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem; }
        .tab:hover { border-color: var(--text-secondary); }
        .tab.active { background: var(--accent-gold); color: var(--bg-dark); border-color: var(--accent-gold); font-weight: 600; }
        .search-box { width: 100%; padding: 1rem; font-size: 1.1rem; background: var(--bg-card); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); margin-bottom: 1rem; }
        .search-box:focus { outline: none; border-color: var(--accent-gold); }
        .filters { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .filter-btn { padding: 0.5rem 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); cursor: pointer; font-size: 0.85rem; }
        .filter-btn:hover { border-color: var(--text-secondary); }
        .filter-btn.active { background: var(--border); color: var(--text-primary); }
        .stats { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem 1.5rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .stat { text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: 600; color: var(--accent-green); }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; }
        .items-list { display: flex; flex-direction: column; gap: 0.5rem; max-height: 400px; overflow-y: auto; padding-right: 0.5rem; margin-bottom: 1.5rem; }
        .item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; transition: all 0.15s; }
        .item:hover { border-color: var(--accent-gold); }
        .item.obtained { border-color: var(--accent-green); background: rgba(63, 185, 80, 0.1); }
        .checkbox { width: 24px; height: 24px; border: 2px solid var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; cursor: pointer; }
        .item.obtained .checkbox { background: var(--accent-green); border-color: var(--accent-green); color: var(--bg-dark); }
        .item-info { flex: 1; min-width: 0; }
        .item-name { font-weight: 500; }
        .item-category { font-size: 0.8rem; color: var(--text-secondary); }
        .item-date-input { padding: 0.4rem 0.6rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 0.8rem; width: 130px; }
        .item-date-input:focus { outline: none; border-color: var(--accent-gold); }
        .output-section { margin-top: 1rem; }
        .output-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; gap: 1rem; flex-wrap: wrap; }
        .output-title { font-size: 1rem; color: var(--text-secondary); }
        .btn { padding: 0.75rem 1.5rem; background: var(--accent-gold); color: var(--bg-dark); border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .btn:hover { opacity: 0.9; }
        .btn.copied { background: var(--accent-green); }
        .btn.secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
        .output-box { width: 100%; height: 250px; padding: 1rem; font-family: 'Fira Code', Consolas, monospace; font-size: 0.8rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); resize: vertical; }
        .instructions { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; }
        .instructions h3 { color: var(--accent-gold); margin-bottom: 0.75rem; font-size: 1rem; }
        .instructions ol { margin-left: 1.5rem; color: var(--text-secondary); font-size: 0.9rem; }
        .instructions li { margin-bottom: 0.5rem; }
        .instructions code { background: var(--bg-dark); padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.85rem; }
        .instructions a { color: var(--accent-gold); }
        .no-results { text-align: center; padding: 3rem; color: var(--text-secondary); }
        .change-count { background: var(--accent-gold); color: var(--bg-dark); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .loading { text-align: center; padding: 3rem; color: var(--text-secondary); }
        .error { background: rgba(248, 81, 73, 0.1); border: 1px solid var(--accent-red); color: var(--accent-red); padding: 1rem; border-radius: 6px; margin-bottom: 1rem; }
        .btn-group { display: flex; gap: 0.5rem; }
        .today-btn { padding: 0.3rem 0.5rem; background: var(--border); border: none; border-radius: 3px; color: var(--text-secondary); cursor: pointer; font-size: 0.7rem; }
        .today-btn:hover { background: var(--accent-gold); color: var(--bg-dark); }
        
        /* Kanban Board Styles */
        .goals-container { display: none; }
        .goals-container.active { display: block; }
        .kanban-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        @media (max-width: 900px) { .kanban-board { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 500px) { .kanban-board { grid-template-columns: 1fr; } }
        .kanban-column { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; min-height: 300px; }
        .kanban-header { font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; padding-bottom: 0.75rem; margin-bottom: 0.75rem; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .kanban-header .count { background: var(--bg-dark); padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.75rem; }
        .kanban-column.backlog .kanban-header { color: #9ca3af; border-color: #4b5563; }
        .kanban-column.in-progress .kanban-header { color: #60a5fa; border-color: #3b82f6; }
        .kanban-column.blocked .kanban-header { color: #f85149; border-color: #f85149; }
        .kanban-column.completed .kanban-header { color: #3fb950; border-color: #3fb950; }
        .kanban-card { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; cursor: grab; position: relative; transition: transform 0.1s, box-shadow 0.1s; }
        .kanban-card:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.3); border-color: var(--accent-gold); }
        .kanban-card.dragging { opacity: 0.5; cursor: grabbing; }
        .kanban-card .card-title { font-size: 0.9rem; padding-right: 1.5rem; }
        .kanban-card .card-date { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .kanban-card .delete-btn { position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1rem; line-height: 1; }
        .kanban-card .delete-btn:hover { color: var(--accent-red); }
        .kanban-column.completed .kanban-card .card-title { text-decoration: line-through; color: var(--text-secondary); }
        .add-card-form { margin-top: 0.5rem; }
        .add-card-input { width: 100%; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); padding: 0.5rem; font-size: 0.85rem; margin-bottom: 0.5rem; }
        .add-card-input:focus { outline: none; border-color: var(--accent-gold); }
        .add-card-btn { width: 100%; background: transparent; border: 1px dashed var(--border); border-radius: 4px; color: var(--text-secondary); padding: 0.5rem; cursor: pointer; font-size: 0.85rem; }
        .add-card-btn:hover { border-color: var(--accent-gold); color: var(--text-primary); }
        .drop-zone { border: 2px dashed var(--accent-gold) !important; background: rgba(212, 168, 75, 0.1); }
        .kanban-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù Progress Editor</h1>
        <p class="subtitle">Toggle items and add dates, then copy the YAML to GitHub</p>

        <div class="instructions" id="mainInstructions">
            <h3>How to use:</h3>
            <ol>
                <li>Search for an item you completed</li>
                <li>Click the checkbox to toggle obtained/completed</li>
                <li>Add a date (click "Today" for quick entry)</li>
                <li>Click <strong>"Copy YAML"</strong></li>
                <li>Go to GitHub ‚Üí edit the appropriate YAML file ‚Üí paste ‚Üí commit</li>
            </ol>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="clog">Collection Log</button>
            <button class="tab" data-tab="ca">Combat Achievements</button>
            <button class="tab" data-tab="pets">Pets üêæ</button>
            <button class="tab" data-tab="goals">Goals üìã</button>
        </div>

        <div id="error" class="error" style="display:none"></div>

        <input type="text" class="search-box" id="search" placeholder="Search items...">

        <div class="filters" id="filters"></div>

        <div class="stats" id="stats"><div class="loading">Loading data...</div></div>

        <div class="items-list" id="itemsList"><div class="loading">Loading...</div></div>

        <div class="output-section">
            <div class="output-header">
                <span class="output-title">Generated YAML <span class="change-count" id="changeCount" style="display:none">0 changes</span></span>
                <div class="btn-group">
                    <button class="btn secondary" id="resetBtn">Reset</button>
                    <button class="btn" id="copyBtn">Copy YAML</button>
                </div>
            </div>
            <textarea class="output-box" id="output" readonly></textarea>
        </div>
        
        <!-- Goals Kanban Board -->
        <div class="goals-container" id="goalsContainer">
            <div class="instructions">
                <h3>How to use the Goals Board:</h3>
                <ol>
                    <li>Drag and drop cards between columns to change status</li>
                    <li>Click <strong>"+ Add Goal"</strong> at the bottom of any column</li>
                    <li>Click <strong>√ó</strong> to delete a goal</li>
                    <li>When you move a goal to Completed, today's date is auto-added</li>
                    <li>Click <strong>"Download YAML"</strong> then upload to <code>data/goals.yaml</code></li>
                </ol>
            </div>
            <div class="kanban-board" id="kanbanBoard"></div>
            <div class="kanban-actions">
                <button class="btn" id="downloadGoalsBtn">üì• Download goals.yaml</button>
                <button class="btn secondary" id="loadGoalsBtn">üì§ Load from File</button>
                <input type="file" id="goalsFileInput" accept=".yaml,.yml" style="display:none">
            </div>
        </div>
    </div>

    <script>
        const GITHUB_BASE = 'https://raw.githubusercontent.com/foolish127/osrs-ironman-progession-tracker/main/data';
        
        let currentTab = 'clog';
        let currentFilter = 'all';
        let data = {};
        let originalData = {};

        function parseYamlWithDates(text, isPets = false) {
            if (isPets) {
                // Pets have flat structure: obtained:/missing: at root level
                const result = { obtained: [], missing: [] };
                let currentSection = null;
                
                for (const line of text.split('\n')) {
                    if (!line || line.startsWith('#')) continue;
                    const stripped = line.trim();
                    
                    if (stripped === 'obtained:') {
                        currentSection = 'obtained';
                    } else if (stripped === 'missing:') {
                        currentSection = 'missing';
                    } else if (stripped.startsWith('- ') && currentSection) {
                        const itemText = stripped.slice(2);
                        let name, date = null;
                        
                        if (itemText.includes(' | ')) {
                            const parts = itemText.split(' | ');
                            name = parts[0].trim();
                            date = parts[1]?.trim() || null;
                        } else if (itemText.endsWith(' |')) {
                            name = itemText.slice(0, -2).trim();
                        } else {
                            name = itemText.trim();
                        }
                        
                        result[currentSection].push({ name, date });
                    }
                }
                return result;
            }
            
            // Original nested structure for clog and CA
            const result = {};
            let currentKey = null;
            let currentSubkey = null;
            
            for (const line of text.split('\n')) {
                if (!line || line.startsWith('#')) continue;
                
                const stripped = line.trimStart();
                const indent = line.length - stripped.length;
                
                if (indent === 0 && stripped.endsWith(':')) {
                    currentKey = stripped.slice(0, -1);
                    result[currentKey] = {};
                    currentSubkey = null;
                } else if (indent === 2 && stripped.endsWith(':')) {
                    currentSubkey = stripped.slice(0, -1);
                    result[currentKey][currentSubkey] = [];
                } else if (stripped.startsWith('- ') && currentKey && currentSubkey) {
                    const itemText = stripped.slice(2);
                    let name, date = null;
                    
                    if (itemText.includes(' | ')) {
                        const parts = itemText.split(' | ');
                        name = parts[0].trim();
                        date = parts[1]?.trim() || null;
                    } else if (itemText.endsWith(' |')) {
                        name = itemText.slice(0, -2).trim();
                    } else {
                        name = itemText.trim();
                    }
                    
                    result[currentKey][currentSubkey].push({ name, date });
                }
            }
            return result;
        }

        async function loadData() {
            try {
                const files = {
                    clog: 'collection_log.yaml',
                    ca: 'combat_achievements.yaml',
                    pets: 'pets.yaml'
                };
                
                const results = await Promise.all(
                    Object.entries(files).map(async ([key, file]) => {
                        try {
                            const res = await fetch(`${GITHUB_BASE}/${file}`);
                            if (!res.ok) throw new Error(`Failed to load ${file}`);
                            const text = await res.text();
                            return [key, parseYamlWithDates(text, key === 'pets')];
                        } catch (e) {
                            console.error(e);
                            return [key, null];
                        }
                    })
                );
                
                results.forEach(([key, val]) => {
                    if (val) {
                        data[key] = val;
                        originalData[key] = JSON.parse(JSON.stringify(val));
                    }
                });
                
                document.getElementById('error').style.display = 'none';
                render();
            } catch (err) {
                document.getElementById('error').textContent = `Error loading data: ${err}`;
                document.getElementById('error').style.display = 'block';
            }
        }

        function init() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = tab.dataset.tab;
                    currentFilter = 'all';
                    document.getElementById('search').value = '';
                    
                    // Toggle between goals view and regular editor view
                    const goalsContainer = document.getElementById('goalsContainer');
                    const regularElements = ['search', 'filters', 'stats', 'itemsList', 'output'].map(id => document.getElementById(id).parentElement || document.getElementById(id));
                    const outputSection = document.querySelector('.output-section');
                    
                    if (currentTab === 'goals') {
                        goalsContainer.classList.add('active');
                        document.getElementById('mainInstructions').style.display = 'none';
                        document.getElementById('search').style.display = 'none';
                        document.getElementById('filters').style.display = 'none';
                        document.getElementById('stats').style.display = 'none';
                        document.getElementById('itemsList').style.display = 'none';
                        outputSection.style.display = 'none';
                    } else {
                        goalsContainer.classList.remove('active');
                        document.getElementById('mainInstructions').style.display = '';
                        document.getElementById('search').style.display = '';
                        document.getElementById('filters').style.display = '';
                        document.getElementById('stats').style.display = '';
                        document.getElementById('itemsList').style.display = '';
                        outputSection.style.display = '';
                        render();
                    }
                });
            });

            document.getElementById('search').addEventListener('input', render);
            document.getElementById('copyBtn').addEventListener('click', copyYaml);
            document.getElementById('resetBtn').addEventListener('click', resetChanges);
            
            loadData();
        }

        function resetChanges() {
            data[currentTab] = JSON.parse(JSON.stringify(originalData[currentTab]));
            render();
        }

        function getToday() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function render() {
            renderFilters();
            renderStats();
            renderItems();
            renderOutput();
        }

        function renderFilters() {
            const container = document.getElementById('filters');
            let categories;
            
            if (currentTab === 'ca') {
                categories = ['all', 'completed', 'not_completed'];
            } else {
                categories = ['all', 'obtained', 'missing'];
            }
            
            container.innerHTML = categories.map(cat => {
                const label = cat === 'all' ? 'All' : cat === 'not_completed' ? 'Remaining' : cat.charAt(0).toUpperCase() + cat.slice(1);
                return `<button class="filter-btn ${currentFilter === cat ? 'active' : ''}" data-filter="${cat}">${label}</button>`;
            }).join('');
            
            container.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentFilter = btn.dataset.filter;
                    render();
                });
            });
        }

        function renderStats() {
            const container = document.getElementById('stats');
            const tabData = data[currentTab];
            
            if (!tabData) {
                container.innerHTML = '<div class="loading">Loading...</div>';
                return;
            }
            
            let obtained = 0, total = 0, changes = 0;
            
            if (currentTab === 'pets') {
                // Pets have flat structure
                obtained = (tabData.obtained || []).length;
                total = obtained + (tabData.missing || []).length;
            } else {
                const obtKey = currentTab === 'ca' ? 'completed' : 'obtained';
                const missKey = currentTab === 'ca' ? 'not_completed' : 'missing';
                
                for (const [key, items] of Object.entries(tabData)) {
                    obtained += (items[obtKey] || []).length;
                    total += (items[obtKey] || []).length + (items[missKey] || []).length;
                }
            }
            
            // Count changes (simplified)
            const orig = originalData[currentTab];
            if (orig && JSON.stringify(tabData) !== JSON.stringify(orig)) {
                changes = 1; // Just show that there are changes
            }
            
            const pct = total > 0 ? ((obtained / total) * 100).toFixed(1) : 0;
            const label = currentTab === 'ca' ? 'Completed' : 'Obtained';
            
            container.innerHTML = `
                <div class="stat"><div class="stat-value">${obtained}</div><div class="stat-label">${label}</div></div>
                <div class="stat"><div class="stat-value" style="color:var(--text-secondary)">${total}</div><div class="stat-label">Total</div></div>
                <div class="stat"><div class="stat-value">${pct}%</div><div class="stat-label">Progress</div></div>
            `;
            
            const changeCount = document.getElementById('changeCount');
            changeCount.style.display = changes > 0 ? 'inline' : 'none';
            changeCount.textContent = 'unsaved changes';
        }

        function renderItems() {
            const container = document.getElementById('itemsList');
            const tabData = data[currentTab];
            
            if (!tabData) {
                container.innerHTML = '<div class="loading">Loading...</div>';
                return;
            }
            
            const search = document.getElementById('search').value.toLowerCase();
            let html = '';
            
            if (currentTab === 'pets') {
                // Pets have flat structure: { obtained: [], missing: [] }
                let items = [];
                
                if (currentFilter === 'all' || currentFilter === 'obtained') {
                    items = items.concat((tabData.obtained || []).map(i => ({
                        name: i.name,
                        date: i.date,
                        obtained: true,
                        category: 'Pets'
                    })));
                }
                if (currentFilter === 'all' || currentFilter === 'missing') {
                    items = items.concat((tabData.missing || []).map(i => ({
                        name: i.name,
                        date: null,
                        obtained: false,
                        category: 'Pets'
                    })));
                }
                
                if (search) {
                    items = items.filter(i => i.name.toLowerCase().includes(search));
                }
                
                items.sort((a, b) => {
                    if (a.obtained !== b.obtained) return b.obtained - a.obtained;
                    return a.name.localeCompare(b.name);
                });
                
                for (const item of items) {
                    html += renderItemHtml(item, 'pets');
                }
            } else {
                // Collection log and CA have nested structure
                const obtKey = currentTab === 'ca' ? 'completed' : 'obtained';
                const missKey = currentTab === 'ca' ? 'not_completed' : 'missing';
                
                const sortedKeys = currentTab === 'ca' 
                    ? ['Easy', 'Medium', 'Hard', 'Elite', 'Master', 'Grandmaster'].filter(k => tabData[k])
                    : Object.keys(tabData).sort();
                
                for (const category of sortedKeys) {
                    const items = tabData[category];
                    if (!items) continue;
                    
                    let allItems = [];
                    
                    if (currentFilter === 'all' || currentFilter === obtKey) {
                        allItems = allItems.concat((items[obtKey] || []).map(i => ({
                            name: i.name,
                            date: i.date,
                            obtained: true,
                            category
                        })));
                    }
                    if (currentFilter === 'all' || currentFilter === missKey) {
                        allItems = allItems.concat((items[missKey] || []).map(i => ({
                            name: i.name || i,
                            date: null,
                            obtained: false,
                            category
                        })));
                    }
                    
                    for (const item of allItems) {
                        if (search && !item.name.toLowerCase().includes(search) && !item.category.toLowerCase().includes(search)) continue;
                        html += renderItemHtml(item, currentTab);
                    }
                }
            }
            
            container.innerHTML = html || '<div class="no-results">No items found</div>';
            
            // Add event listeners
            container.querySelectorAll('.checkbox').forEach(cb => {
                cb.addEventListener('click', () => toggleItem(cb.dataset.category, cb.dataset.name));
            });
            
            container.querySelectorAll('.item-date-input').forEach(input => {
                input.addEventListener('change', () => updateDate(input.dataset.category, input.dataset.name, input.value));
            });
            
            container.querySelectorAll('.today-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const input = btn.previousElementSibling;
                    input.value = getToday();
                    updateDate(input.dataset.category, input.dataset.name, input.value);
                });
            });
        }

        function renderItemHtml(item, tab) {
            return `<div class="item ${item.obtained ? 'obtained' : ''}">
                <div class="checkbox" data-category="${item.category}" data-name="${item.name}">${item.obtained ? '‚úì' : ''}</div>
                <div class="item-info">
                    <div class="item-name">${item.name}</div>
                    <div class="item-category">${item.category}</div>
                </div>
                ${item.obtained ? `
                    <input type="date" class="item-date-input" data-category="${item.category}" data-name="${item.name}" value="${item.date || ''}">
                    <button class="today-btn">Today</button>
                ` : ''}
            </div>`;
        }

        function toggleItem(category, name) {
            const tabData = data[currentTab];
            
            if (currentTab === 'pets') {
                // Pets have flat structure
                const obtIdx = (tabData.obtained || []).findIndex(i => i.name === name);
                const missIdx = (tabData.missing || []).findIndex(i => i.name === name);
                
                if (obtIdx >= 0) {
                    const item = tabData.obtained.splice(obtIdx, 1)[0];
                    tabData.missing = tabData.missing || [];
                    tabData.missing.push({ name: item.name, date: null });
                } else if (missIdx >= 0) {
                    const item = tabData.missing.splice(missIdx, 1)[0];
                    tabData.obtained = tabData.obtained || [];
                    tabData.obtained.push({ name: item.name, date: getToday() });
                }
            } else {
                const obtKey = currentTab === 'ca' ? 'completed' : 'obtained';
                const missKey = currentTab === 'ca' ? 'not_completed' : 'missing';
                
                const items = tabData[category];
                if (!items) return;
                
                const obtIdx = (items[obtKey] || []).findIndex(i => i.name === name);
                const missIdx = (items[missKey] || []).findIndex(i => (i.name || i) === name);
                
                if (obtIdx >= 0) {
                    const item = items[obtKey].splice(obtIdx, 1)[0];
                    items[missKey] = items[missKey] || [];
                    items[missKey].push({ name: item.name, date: null });
                } else if (missIdx >= 0) {
                    const item = items[missKey].splice(missIdx, 1)[0];
                    items[obtKey] = items[obtKey] || [];
                    items[obtKey].push({ name: item.name || item, date: getToday() });
                }
            }
            
            render();
        }

        function updateDate(category, name, date) {
            const tabData = data[currentTab];
            
            if (currentTab === 'pets') {
                const item = (tabData.obtained || []).find(i => i.name === name);
                if (item) item.date = date || null;
            } else {
                const obtKey = currentTab === 'ca' ? 'completed' : 'obtained';
                const items = tabData[category];
                if (!items) return;
                const item = (items[obtKey] || []).find(i => i.name === name);
                if (item) item.date = date || null;
            }
            
            renderOutput();
        }

        function renderOutput() {
            const output = document.getElementById('output');
            const tabData = data[currentTab];
            
            if (!tabData) {
                output.value = '# Loading...';
                return;
            }
            
            const titles = { clog: 'Collection Log', ca: 'Combat Achievements', pets: 'Pet' };
            
            let yaml = `# FoolinSlays ${titles[currentTab]} Tracker\n`;
            yaml += `# Format: item name | YYYY-MM-DD (date is optional)\n`;
            yaml += `# Last updated: ${getToday()}\n\n`;
            
            if (currentTab === 'pets') {
                yaml += `obtained:\n`;
                for (const item of (tabData.obtained || []).sort((a, b) => a.name.localeCompare(b.name))) {
                    yaml += `  - ${item.name} |${item.date ? ' ' + item.date : ''}\n`;
                }
                yaml += `\nmissing:\n`;
                for (const item of (tabData.missing || []).sort((a, b) => a.name.localeCompare(b.name))) {
                    yaml += `  - ${item.name}\n`;
                }
            } else {
                const obtKey = currentTab === 'ca' ? 'completed' : 'obtained';
                const missKey = currentTab === 'ca' ? 'not_completed' : 'missing';
                
                const sortedKeys = currentTab === 'ca' 
                    ? ['Easy', 'Medium', 'Hard', 'Elite', 'Master', 'Grandmaster'].filter(k => tabData[k])
                    : Object.keys(tabData).sort();
                
                for (const key of sortedKeys) {
                    const items = tabData[key];
                    if (!items) continue;
                    
                    yaml += `${key}:\n`;
                    yaml += `  ${obtKey}:\n`;
                    for (const item of (items[obtKey] || []).sort((a, b) => a.name.localeCompare(b.name))) {
                        yaml += `  - ${item.name} |${item.date ? ' ' + item.date : ''}\n`;
                    }
                    yaml += `  ${missKey}:\n`;
                    for (const item of (items[missKey] || []).sort((a, b) => (a.name || a).localeCompare(b.name || b))) {
                        yaml += `  - ${item.name || item}\n`;
                    }
                }
            }
            
            output.value = yaml;
        }

        function copyYaml() {
            const output = document.getElementById('output');
            output.select();
            navigator.clipboard.writeText(output.value);
            
            const btn = document.getElementById('copyBtn');
            btn.textContent = 'Copied!';
            btn.classList.add('copied');
            
            setTimeout(() => {
                btn.textContent = 'Copy YAML';
                btn.classList.remove('copied');
            }, 2000);
        }

        // ============ GOALS KANBAN BOARD ============
        let goalsData = { backlog: [], in_progress: [], blocked: [], completed: [] };
        const columnConfig = [
            { key: 'backlog', label: 'üìã Backlog', class: 'backlog' },
            { key: 'in_progress', label: 'üî® In Progress', class: 'in-progress' },
            { key: 'blocked', label: 'üö´ Blocked', class: 'blocked' },
            { key: 'completed', label: '‚úÖ Completed', class: 'completed' }
        ];

        async function loadGoalsData() {
            try {
                const yaml = await fetch('./data/goals.yaml').then(r => r.text()).catch(() => null);
                if (yaml) parseGoalsYaml(yaml);
                renderKanbanBoard();
            } catch (e) { console.error('Error loading goals:', e); }
        }

        function parseGoalsYaml(yaml) {
            goalsData = { backlog: [], in_progress: [], blocked: [], completed: [] };
            let current = null;
            yaml.split('\n').forEach(line => {
                if (line.startsWith('backlog:')) current = 'backlog';
                else if (line.startsWith('in_progress:')) current = 'in_progress';
                else if (line.startsWith('blocked:')) current = 'blocked';
                else if (line.startsWith('completed:')) current = 'completed';
                else if (current && line.trim().startsWith('- ')) {
                    const text = line.trim().slice(2);
                    const parts = text.split(' | ');
                    goalsData[current].push({
                        id: Date.now() + Math.random(),
                        title: parts[0].trim(),
                        date: parts[1]?.trim() || null
                    });
                }
            });
        }

        function renderKanbanBoard() {
            const board = document.getElementById('kanbanBoard');
            board.innerHTML = columnConfig.map(col => `
                <div class="kanban-column ${col.class}" data-column="${col.key}">
                    <div class="kanban-header">
                        <span>${col.label}</span>
                        <span class="count">${goalsData[col.key].length}</span>
                    </div>
                    <div class="kanban-cards" data-column="${col.key}">
                        ${goalsData[col.key].map(g => `
                            <div class="kanban-card" draggable="true" data-id="${g.id}">
                                <button class="delete-btn" onclick="deleteGoal('${col.key}', ${g.id})">&times;</button>
                                <div class="card-title">${escapeHtml(g.title)}</div>
                                ${g.date ? `<div class="card-date">${g.date}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    <button class="add-card-btn" onclick="showAddForm('${col.key}')">+ Add Goal</button>
                    <div class="add-card-form" id="form-${col.key}" style="display:none">
                        <input type="text" class="add-card-input" id="input-${col.key}" placeholder="Goal title..." onkeypress="if(event.key==='Enter')addGoal('${col.key}')">
                        ${col.key === 'completed' ? `<input type="date" class="add-card-input" id="date-${col.key}" value="${getToday()}">` : ''}
                        <div class="btn-group"><button class="btn" onclick="addGoal('${col.key}')">Add</button><button class="btn secondary" onclick="hideAddForm('${col.key}')">Cancel</button></div>
                    </div>
                </div>
            `).join('');
            setupDragAndDrop();
        }

        function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function showAddForm(col) { document.getElementById(`form-${col}`).style.display = 'block'; document.getElementById(`input-${col}`).focus(); }
        function hideAddForm(col) { document.getElementById(`form-${col}`).style.display = 'none'; document.getElementById(`input-${col}`).value = ''; }

        function addGoal(col) {
            const title = document.getElementById(`input-${col}`).value.trim();
            if (title) {
                const goal = { id: Date.now() + Math.random(), title, date: null };
                if (col === 'completed') goal.date = document.getElementById(`date-${col}`)?.value || getToday();
                goalsData[col].push(goal);
                renderKanbanBoard();
            }
        }

        function deleteGoal(col, id) { if (confirm('Delete this goal?')) { goalsData[col] = goalsData[col].filter(g => g.id !== id); renderKanbanBoard(); } }

        function moveGoal(cardId, targetCol) {
            let goal = null, sourceCol = null;
            for (const col of Object.keys(goalsData)) {
                const idx = goalsData[col].findIndex(g => g.id === cardId);
                if (idx !== -1) { goal = goalsData[col].splice(idx, 1)[0]; sourceCol = col; break; }
            }
            if (goal) {
                if (targetCol === 'completed' && !goal.date) goal.date = getToday();
                if (targetCol !== 'completed' && sourceCol === 'completed') goal.date = null;
                goalsData[targetCol].push(goal);
                renderKanbanBoard();
            }
        }

        function setupDragAndDrop() {
            document.querySelectorAll('.kanban-card').forEach(card => {
                card.addEventListener('dragstart', e => { card.classList.add('dragging'); e.dataTransfer.setData('text/plain', card.dataset.id); });
                card.addEventListener('dragend', () => { card.classList.remove('dragging'); document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('drop-zone')); });
            });
            document.querySelectorAll('.kanban-cards').forEach(col => {
                col.addEventListener('dragover', e => { e.preventDefault(); col.classList.add('drop-zone'); });
                col.addEventListener('dragleave', () => col.classList.remove('drop-zone'));
                col.addEventListener('drop', e => { e.preventDefault(); col.classList.remove('drop-zone'); moveGoal(parseFloat(e.dataTransfer.getData('text/plain')), col.dataset.column); });
            });
        }

        function generateGoalsYaml() {
            let yaml = '# FoolinSlays Goals Tracker\n# Kanban-style goal tracking\n\n';
            columnConfig.forEach(col => {
                yaml += `${col.key}:\n`;
                goalsData[col.key].forEach(g => yaml += `  - ${g.title}${g.date ? ' | ' + g.date : ''}\n`);
                yaml += '\n';
            });
            return yaml;
        }

        document.getElementById('downloadGoalsBtn').addEventListener('click', () => {
            const blob = new Blob([generateGoalsYaml()], { type: 'text/yaml' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'goals.yaml'; a.click();
        });
        document.getElementById('loadGoalsBtn').addEventListener('click', () => document.getElementById('goalsFileInput').click());
        document.getElementById('goalsFileInput').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) { const r = new FileReader(); r.onload = ev => { parseGoalsYaml(ev.target.result); renderKanbanBoard(); }; r.readAsText(file); }
        });

        init();
        loadGoalsData();
    </script>
</body>
</html>
